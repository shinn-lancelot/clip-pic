<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>clip-pic</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        .wrapper {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-wrap: nowrap;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            user-select: none;
        }

        .box {
            background: #232429;
            position: relative;
            font-size: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            flex-wrap: nowrap;
            justify-content: center;
            align-items: center;
        }

        .title {
            margin: 0 auto 20px;
        }

        .clip-img {
            width: 100%;
        }

        #drag {
            background: transparent;
            position: absolute;
            z-index: 10000;
            user-select: none;
            border: 1px dashed #fff;
            box-sizing: border-box;
        }

        .dot-box {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .dot {
            position: absolute;
            z-index: 10001;
            width: 10px;
            height: 10px;
            background: #fff;
            box-sizing: border-box;
            border: 1px solid #767676;
            user-select: none;
        }
        .up {
            cursor: n-resize;
            top: -5.5px;
        }

        .down {
            cursor: s-resize;
            bottom: -5.5px;
        }

        .left {
            cursor: w-resize;
            left: -5.5px;
        }

        .right {
            cursor: e-resize;
            right: -5.5px;
        }

        .left-up {
            cursor: nw-resize;
            top: -5.5px;
            left: -5.5px;
        }

        .right-up {
            cursor: ne-resize;
            top: -5.5px;
            right: -5.5px;
        }

        .left-down {
            cursor: sw-resize;
            bottom: -5.5px;
            left: -5.5px;
        }

        .right-down {
            cursor: se-resize;
            bottom: -5.5px;
            right: -5.5px;
        }

        .btn-box {
            margin-top: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            flex-wrap: nowrap;
            justify-content: center;
            align-items: center;
        }

        .clip-btn {
            width: 100%;
            line-height: 40px;
            font-size: 16px;
            background: rgb(85, 189, 59);
            text-align: center;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            opacity: .9;
        }
        .clip-btn:active {
            opacity: 1 !important;
        }
        .clip-btn:hover {
            opacity: .8;
        }

        .loading {
            width: 100vw;
            height: 100vh;
            color: #000;
            background: #fff;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1000000;
            display: flex;
            flex-wrap: nowrap;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="loading">loading...</div>
    <div class="wrapper">
        <div class="title">An example of clipping a picture with canvas. <a href="https://github.com/shinn-lancelot/clip-pic">Github Repository</a></div>
        <div class="box">
            <img class="clip-img" ondragstart="return false" alt="">
            <div id="drag">
                <div class="dot-box">
                    <div class="up dot"></div>
                    <div class="down dot"></div>
                    <div class="left dot"></div>
                    <div class="right dot"></div>
                    <div class="left-up dot"></div>
                    <div class="right-up dot"></div>
                    <div class="left-down dot"></div>
                    <div class="right-down dot"></div>
                </div>
            </div>
        </div>
        <div class="btn-box">
            <div class="clip-btn">clip</div>
        </div>
    </div>
    <script>
        var drag = document.getElementById('drag'),
            title = document.getElementsByClassName('title')[0],
            box = document.getElementsByClassName('box')[0],
            btnBox = document.getElementsByClassName('btn-box')[0],
            dots = document.getElementsByClassName('dot'),
            dotUp = document.getElementsByClassName('up')[0],
            dotDown = document.getElementsByClassName('down')[0],
            dotLeft = document.getElementsByClassName('left')[0],
            dotRight = document.getElementsByClassName('right')[0],
            loading = document.getElementsByClassName('loading')[0],
            sx = 0,
            sy = 0,
            swidth = 0,
            sheight = 0,
            canvas = document.createElement('canvas'),
            context = canvas.getContext('2d'),
            clipBtn = document.getElementsByClassName('clip-btn')[0],
            wrapperObj = document.getElementsByClassName('wrapper')[0],
            imgObj = document.getElementsByClassName('clip-img')[0],
            widthScale = 1, // 实际图片宽度 / 显示图片宽度
            heightScale = 1,    // 实际图片高度 / 显示图片高度
            imgPath = './images/yamap.jpg',
            img = new Image(),
            boxWidth = 300, // 页面显示盒子的宽度（px）
            cliped = false, // 是否已裁剪
            clipConfig = {  // 裁剪配置对象
                scale: '',   // 设定初始裁剪框比例（宽 / 高）
                fix: true   // 是否固定裁剪框比例
            },
            imgScale;   // 图片自身的比例（宽 / 高）
            
        // 裁剪框比例不存在时，设定默认比例
        if (!clipConfig.scale) {
            clipConfig.scale = 1 / 1;
        }

        // 设置显示盒子的宽度
        if (boxWidth > document.body.clientWidth) {
            boxWidth = document.body.clientWidth;
        }
        box.style.width = boxWidth + 'px';
        btnBox.style.width = box.style.width;
        title.style.width = box.style.width;
        // 设置需要裁剪的图片对象的源，用于裁剪查看
        imgObj.src = imgPath;
        // 设置创建的图片对象的源，用于获取图片原尺寸
        img.src = imgPath;

        window.onload = function() {
            imgScale = imgObj.width / imgObj.height;
            if (imgScale >= clipConfig.scale) {
                drag.style.top = 0;
                drag.style.left = ((imgObj.width - imgObj.height * clipConfig.scale) / 2) + 'px';
                drag.style.height = imgObj.height + 'px';
                drag.style.width = (imgObj.height * clipConfig.scale) + 'px';

                dotUp.style.left = (imgObj.height * clipConfig.scale - 10) / 2 + 'px';
                dotDown.style.left = (imgObj.height * clipConfig.scale - 10) / 2 + 'px';
                dotLeft.style.top = (imgObj.height - 10) / 2 + 'px';
                dotRight.style.top = (imgObj.height - 10) / 2 + 'px';
            } else {
                drag.style.left = 0;
                drag.style.top = ((imgObj.height - imgObj.width / clipConfig.scale) / 2) + 'px';
                drag.style.width = imgObj.width + 'px';
                drag.style.height = (imgObj.width / clipConfig.scale) + 'px';
                
                dotUp.style.left = (imgObj.width - 10) / 2 + 'px';
                dotDown.style.left = (imgObj.width - 10) / 2 + 'px';
                dotLeft.style.top = (imgObj.width / clipConfig.scale - 10) / 2 + 'px';
                dotRight.style.top = (imgObj.width / clipConfig.scale - 10) / 2 + 'px';
            }

            // 获取裁剪坐标原点
            sx = (imgObj.width - drag.offsetWidth) / 2;
            sy = (imgObj.height - drag.offsetHeight) / 2;

            // 设定剪裁框外阴影（遮罩）
            drag.style.outline = 'rgba(0, 0, 0, .5) solid ' + (imgObj.width > imgObj.height ? imgObj.width : imgObj.height) + 'px';

            // 获取显示图与实际图的宽高缩放比
            widthScale = img.width / imgObj.width;
            heightScale = img.height / imgObj.height;

            // 隐藏加载层
            loading.style.display = 'none';
        }

        // 遍历裁剪框缩放点对象
        for (var i = 0; i < dots.length; i++) {

        }

        // 裁剪按钮
        clipBtn.addEventListener('click', clip);

        // 双击裁剪框执行剪裁
        drag.addEventListener('dblclick', clip);

        document.onkeydown = function(ev) {
            var e = ev || window.event,
                key = e.keyCode,
                position = 0,
                deltaWidth = 0,
                deltaHeight = 0;
            switch (key) {
                // 按了←键
                case 37:
                    position = drag.style.left.replace(/px/g, '');
                    position--;
                    if (position < 0) {
                        position = 0;
                    }
                    drag.style.left = position + 'px';
                    break;
                // 按了↑键
                case 38:
                    position = drag.style.top.replace(/px/g, '');
                    position--;
                    if (position < 0) {
                        position = 0;
                    }
                    drag.style.top = position + 'px';
                    break;
                // 按了→键
                case 39:
                    position = drag.style.left.replace(/px/g, '');
                    deltaWidth = imgObj.width - drag.style.width.replace(/px/g, '');
                    position++;
                    if (position > deltaWidth) {
                        position = deltaWidth;
                    }
                    drag.style.left = position + 'px';
                    break;
                // 按了↓键
                case 40:
                    position = drag.style.top.replace(/px/g, '');
                    deltaHeight = imgObj.height - drag.style.height.replace(/px/g, '');
                    position++;
                    if (position > deltaHeight) {
                        position = deltaHeight;
                    }
                    drag.style.top = position + 'px';
                    break;
                // 按了enter键
                case 13:
                    clip();
                    break;
                default:
                    console.log('keycode = ' + key);
            }
        }

        // 鼠标点击裁剪框
        drag.onmousedown = function(event) {
            event.stopPropagation();
            var ev = event || window.event;
            var distanceX = ev.clientX - drag.offsetLeft;
            var distanceY = ev.clientY - drag.offsetTop;
            var left = 0;
            var top = 0;
            // 鼠标经过容器
            box.onmousemove = function(event) {
                var e = event || window.event;
                left = e.clientX - distanceX;
                top = e.clientY - distanceY;
                if (left <= 0) {
                    left = 0;
                } else if (left >= (box.offsetWidth - drag.offsetWidth)) {
                    left = box.offsetWidth - drag.offsetWidth;
                }
                if (top <= 0) {
                    top = 0;
                } else if (top >= (box.offsetHeight - drag.offsetHeight)) {
                    top = box.offsetHeight - drag.offsetHeight;
                }
                drag.style.left = left + 'px';
                drag.style.top = top + 'px';
            };
        };

        // 开始触碰裁剪框
        drag.ontouchstart = function(event) {
            event.stopPropagation();
            var ev = event || window.event;
            var distanceX = ev.touches[0].clientX - drag.offsetLeft;
            var distanceY = ev.touches[0].clientY - drag.offsetTop;
            var left = 0;
            var top = 0;
            // 触碰后移动裁剪框
            box.ontouchmove = function(event) {
                var e = event || window.event;
                left = e.touches[0].clientX - distanceX;
                top = e.touches[0].clientY - distanceY;
                if (left <= 0) {
                    left = 0;
                } else if (left >= (box.offsetWidth - drag.offsetWidth)) {
                    left = box.offsetWidth - drag.offsetWidth;
                }
                if (top <= 0) {
                    top = 0;
                } else if (top >= (box.offsetHeight - drag.offsetHeight)) {
                    top = box.offsetHeight - drag.offsetHeight;
                }
                drag.style.left = left + 'px';
                drag.style.top = top + 'px';
            };
        };

        // 鼠标经过裁剪框
        drag.addEventListener('mouseover', dragMouseOver);

        // 鼠标、触屏松开裁剪框
        drag.addEventListener('mouseup', dragMouseUp);
        drag.addEventListener('touchend', dragMouseUp);

        // 鼠标移出裁剪框
        drag.addEventListener('mouseout', dragMouseOut);

        // 鼠标移出容器
        box.onmouseout = function() {
            box.onmouseover = null;
        }

        function dragMouseOver() {
            drag.style.cursor = 'move';
        }

        function dragMouseUp() {
            box.onmousemove = null;
        };

        function dragMouseOut() {
            box.onmousemove = null;
            drag.style.cursor = 'default';
        }

        function clip() {
            if (cliped) {
                return;
            }
            cliped = true;
            if (drag.style.left) {
                sx = drag.style.left.replace(/px/g, '');
            }
            if (drag.style.top) {
                sy = drag.style.top.replace(/px/g, '');
            }
            // 根据裁剪框获取裁剪尺寸
            swidth = drag.offsetWidth;
            sheight = drag.offsetHeight;

            console.log('dragObj：sx = ' + sx + ' | sy = ' + sy + ' | swidth = ' + swidth + ' | sheight = ' + sheight);
            console.log('imgObj：x = ' + 0 + ' | y = ' + 0 + ' | width = ' + imgObj.width + ' | height = ' + imgObj.height);
            console.log('newImg(after clip)：width = ' + swidth * widthScale + ' | height = ' + sheight * heightScale);
            console.log('img(before clip)：width = ' + imgObj.width * widthScale + ' | height = ' + imgObj.height * heightScale);
            
            // 裁剪时对尺寸根据比例还原，基于原尺寸裁剪
            canvas.width = swidth * widthScale;
            canvas.height = sheight * widthScale;
            context.drawImage(imgObj, sx * widthScale, sy * heightScale, swidth * widthScale, sheight *  heightScale, 0, 0, swidth * widthScale, sheight * heightScale);

            // 图片展示时，根据裁剪框尺寸展示（不按剪裁的尺寸展示）
            var newImg = new Image();
            newImg.src = canvas.toDataURL('image/jpeg', 1);
            newImg.width = swidth;
            newImg.height = sheight;
            box.innerHTML = '';
            box.appendChild(newImg);
            btnBox.innerHTML = '<div>Clip successed! <a href="' + window.location.href.split('\?')[0] + '?&t=' + new Date().getTime() + '">Try it once ?</a></div>';
        }
    </script>
</body>
</html>